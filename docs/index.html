<html>
  <head>
    <script src="../node_modules/monaco-editor/dev/vs/loader.js"></script>
    <script src="../dist/index.js"></script>

    <link rel="stylesheet" type="text/css" href="../dist/index.css" />

    <style>
      body {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .editor {
        flex: 0.5;
        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <h5>Regular Editor - Press CTRL+F10 to add comment, CTRL+Enter to save comment</h5>
    <div class="editor" id="containerEditor"></div>
    <div id="summaryEditor"></div>
    <h5>Diff Editor - Press CTRL+F10 to add comment or ContextMenu</h5>
    <div class="editor" id="containerDiff"></div>
    <div id="summaryDiff"></div>
  </body>
</html>

<script>
  function ensureMonacoIsAvailable() {
    return new Promise(resolve => {
      if (!window.require) {
        console.warn(
          "Unable to find a local node_modules folder - so dynamically using cdn instead"
        );
        var prefix = "https://microsoft.github.io/monaco-editor";
        scriptTag = document.createElement("script");
        scriptTag.src = prefix + "/node_modules/monaco-editor/min/vs/loader.js";
        scriptTag.onload = () => {
          console.debug("Monaco loader is initialized");
          resolve(prefix);
        };
        document.body.appendChild(scriptTag);
      } else {
        resolve("..");
      }
    });
  }

  async function init() {
    var prefix = await ensureMonacoIsAvailable();
    var response = await fetch("../src/index.ts");
    var text = await response.text();

    require.config({
      paths: { vs: prefix + "/node_modules/monaco-editor/min/vs" }
    });

    require(["vs/editor/editor.main"], function() {
      var editor = monaco.editor.create(
        document.getElementById("containerEditor"),
        {
          value: text,
          language: "typescript",
          glyphMargin: true,
          contextmenu: true,
          automaticLayout: true
        }
      );

      initReviewManager(editor, document.getElementById("summaryEditor"));

      var modifiedText = text.slice(0, 100) + "\nMODIFIED\n" + text.slice(100);

      var originalModel = monaco.editor.createModel(text, "typescript");
      var modifiedModel = monaco.editor.createModel(modifiedText, "typescript");

      var diffEditor = monaco.editor.createDiffEditor(
        document.getElementById("containerDiff")
      );
      diffEditor.setModel({
        original: originalModel,
        modified: modifiedModel
      });

      initReviewManager(
        diffEditor.modifiedEditor,
        document.getElementById("summaryDiff")
      );
    });
  }

  function initReviewManager(editor, summaryDiv) {
    var comments = [
      new MonacoEditorCodeReview.ReviewComment(
        "id-0",
        1,
        "another reviewer",
        new Date("2019-01-01"),
        "at start"
      ),

      new MonacoEditorCodeReview.ReviewComment(
        "id-2",
        50,
        "another reviewer",
        new Date("2019-01-01"),
        "at start"
      ),
      new MonacoEditorCodeReview.ReviewComment(
        "id-1",
        24,
        "another reviewer",
        new Date("2019-01-01"),
        "this code isn't very good",
        [
          new MonacoEditorCodeReview.ReviewComment(
            "id-2",
            24,
            "original author",
            new Date("2019-01-01"),
            "I think you will find it is good enough"
          )
        ]
      )
    ];

    var rm = MonacoEditorCodeReview.createReviewManager(
      editor,
      "mr reviewer",
      comments,
      updatedComments => renderComments(summaryDiv, updatedComments)
    );

    renderComments(summaryDiv, comments);
  }

  function renderComments(element, comments) {
    element.innerHTML = comments
      .map(
        comment =>
          `<div>${comment.id} ${comment.lineNumber} ${comment.author} ${
            comment.text
          } ${comment.deleted ? "DELETED" : ""}</div>`
      )
      .join("");
    console.log(
      "Comments Changed:",
      comments
        .map(
          comment =>
            `${comment.id} ${comment.lineNumber} ${comment.author} ${
              comment.text
            } ${comment.deleted}`
        )
        .join("\n")
    );
  }

  init();
</script>
