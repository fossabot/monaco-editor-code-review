<html>
  <head>
    <script src="../node_modules/monaco-editor/dev/vs/loader.js"></script>
    <script src="../dist/index.js"></script>

    <link rel="stylesheet" type="text/css" href="../dist/index.css" />

    <style>
      body {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .editor {
        flex: auto;
        overflow: hidden;
      }
      h5 {
        height: 20px;
      }
      .summary {
        height: 100px;
        padding: 10px;
        overflow: auto;
      }
    </style>
  </head>

  <body>
    <div>
      <div>Choose Monaco Mode</div>
      <button onclick="setView('standard')">Editor</button>
      <button onclick="setView('standard-readonly')">Editor - Readonly</button>
      <button onclick="setView('inline')">Diff - Inline</button>
      <button onclick="setView('side-by-side')">Diff - Side-by-Side</button>
    </div>
    <h5>
      Regular Editor - Press CTRL+F10 to add comment, CTRL+Enter to save comment
    </h5>
    <div class="editor" id="containerEditor"></div>
    <div class="summary" id="summaryEditor"></div>
    <!-- <h5>Diff Editor - Press CTRL+F10 to add comment or ContextMenu</h5>
    <div class="editor" id="containerDiff"></div>//-->
  </body>
</html>

<script>
  function ensureMonacoIsAvailable() {
    return new Promise(resolve => {
      if (!window.require) {
        console.warn(
          "Unable to find a local node_modules folder - so dynamically using cdn instead"
        );
        var prefix = "https://microsoft.github.io/monaco-editor";
        scriptTag = document.createElement("script");
        scriptTag.src = prefix + "/node_modules/monaco-editor/min/vs/loader.js";
        scriptTag.onload = () => {
          console.debug("Monaco loader is initialized");
          resolve(prefix);
        };
        document.body.appendChild(scriptTag);
      } else {
        resolve("..");
      }
    });
  }

  function setView(mode) {
    document.getElementById("containerEditor").innerHTML = "";
    if (mode.startsWith("standard")) {
      var editor = monaco.editor.create(
        document.getElementById("containerEditor"),
        {
          value: window.exampleText,
          language: "typescript",
          glyphMargin: true,
          contextmenu: true,
          automaticLayout: true,
          readOnly: mode === "standard-readonly"
        }
      );

      initReviewManager(editor, document.getElementById("summaryEditor"));
    } else {
      var originalModel = monaco.editor.createModel(
        window.exampleText,
        "typescript"
      );
      var modifiedModel = monaco.editor.createModel(
        window.modifiedText,
        "typescript"
      );

      var diffEditor = monaco.editor.createDiffEditor(
        document.getElementById("containerEditor"),
        { renderSideBySide: mode !== "inline" }
      );
      diffEditor.setModel({
        original: originalModel,
        modified: modifiedModel
      });

      initReviewManager(diffEditor.modifiedEditor);
    }
  }

  async function init() {
    var prefix = await ensureMonacoIsAvailable();
    var response = await fetch("../src/index.ts");
    window.exampleText = await response.text();
    window.modifiedText = window.exampleText.replace(
      new RegExp("string", "g"),
      "string /* String!*/"
    );

    response = await fetch("../dist/timestamp.json");
    tsobj = await response.json();
    console.log("Compiled at:", tsobj.date);

    require.config({
      paths: { vs: prefix + "/node_modules/monaco-editor/min/vs" }
    });

    require(["vs/editor/editor.main"], function() {
      setView("standard");
    });
  }

  function initReviewManager(editor) {
    var comments = [
      new MonacoEditorCodeReview.ReviewComment(
        "id-0",
        1,
        "another reviewer",
        new Date("2019-01-01"),
        "at start"
      ),     
      
      new MonacoEditorCodeReview.ReviewComment(
        "id-2",
        50,
        "another reviewer",
        new Date("2019-01-01"),
        "at start"
      ),
      new MonacoEditorCodeReview.ReviewComment(
        "id-1",
        24,
        "another reviewer",
        new Date("2019-01-01"),
        "this code isn't very good",
        [
          new MonacoEditorCodeReview.ReviewComment(
            "id-2",
            24,
            "original author",
            new Date("2019-01-01"),
            "I think you will find it is good enough"
          )
        ]
      )
    ];

    var summaryDiv = document.getElementById("summaryEditor");
    var rm = MonacoEditorCodeReview.createReviewManager(
      editor,
      "mr reviewer",
      comments,
      updatedComments => renderComments(summaryDiv, updatedComments),
      { editButtonEnableRemove: false }
    );

    renderComments(summaryDiv, comments);
  }

  function renderComments(element, comments) {
    comments = comments || [];
    element.innerHTML = comments
      .map(
        comment =>
          `<div>${comment.id} ${comment.lineNumber} ${comment.author} ${
            comment.text
          } ${comment.deleted ? "DELETED" : ""}</div>`
      )
      .join("");
    console.log(
      "Comments Changed:",
      comments
        .map(
          comment =>
            `${comment.id} ${comment.lineNumber} ${comment.author} ${
              comment.text
            } ${comment.deleted}`
        )
        .join("\n")
    );
  }

  init();
</script>
